<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#000000" />
  
  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Vader Vocoder">
  
  <!-- Manifest and Icons -->
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="icon" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/icon-192.png">
  <link rel="apple-touch-icon" sizes="512x512" href="icons/icon-512.png">
  <title>Vader Vocoder PWA</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>Vader Vocoder</h1>
    <div class="header-buttons">
      <button id="updateBtn" hidden>Update Available</button>
      <button id="installBtn" hidden>Install</button>
    </div>
  </header>

  <main>
    <section class="devices">
      <h2>Audio Devices & Routing</h2>
      
      <!-- Input Device Selection -->
      <div class="device-group">
        <h3>ğŸ¤ Input Device</h3>
        <div class="row">
          <label for="micSelect">Microphone</label>
          <select id="micSelect"></select>
          <span id="micType" class="device-type"></span>
          <button id="refreshDevs">â†»</button>
        </div>
        <div class="row">
          <label>Input Volume
            <input id="inputVolume" type="range" min="0" max="2" step="0.01" value="1.0">
            <output id="inputVolumeOut">1.0</output>
          </label>
          <button id="muteInput" class="mute-btn">ğŸ”‡ Mute Input</button>
        </div>
      </div>

      <!-- Output Device Selection -->
      <div class="device-group">
        <h3>ğŸ”Š Output Device</h3>
        <div class="row">
          <label for="outSelect">Audio Output</label>
          <select id="outSelect" title="Requires browser support for setSinkId"></select>
          <span id="outType" class="device-type"></span>
          <button id="requestSpeakerPermission" class="permission-btn">ğŸ”“ Enable Speakers</button>
        </div>
        <div class="row">
          <label>Output Volume
            <input id="outputVolume" type="range" min="0" max="2" step="0.01" value="0.8">
            <output id="outputVolumeOut">0.8</output>
          </label>
          <button id="muteOutput" class="mute-btn">ğŸ”‡ Mute Output</button>
        </div>
        <small class="hint">ğŸ’¡ Use different devices for mic and speakers to prevent feedback</small>
      </div>

      <!-- Feedback Prevention -->
      <div class="device-group">
        <h3>ğŸ›¡ï¸ Feedback Prevention</h3>
        <div class="row">
          <label><input type="checkbox" id="autoFeedbackPrevention" checked> Auto Feedback Prevention</label>
          <button id="testAudio">ğŸ”Š Test Audio</button>
          <button id="diagnoseBluetooth" class="diagnostic-btn">ğŸ” Diagnose BT</button>
        </div>
        <div class="row feedback-warning hidden" id="feedbackWarning">
          âš ï¸ Same device detected for input and output - feedback risk!
        </div>
      </div>

      <!-- Control Buttons -->
      <div class="row">
        <button id="startBtn">â–¶ï¸ Start Vocoder</button>
        <button id="stopBtn" disabled>â¹ï¸ Stop</button>
      </div>
    </section>

    
    <section class="controls">
      <h2>Voice Controls</h2>

      <div class="grid">
        <label>Master Gain
          <input id="gain" type="range" min="0" max="2" step="0.01" value="1.2">
          <output id="gainOut">1.2</output>
        </label>

        <label>Wet Mix
          <input id="wet" type="range" min="0" max="1" step="0.01" value="0.6">
          <output id="wetOut">0.6</output>
        </label>

        <label>Dry Mix
          <input id="dry" type="range" min="0" max="1" step="0.01" value="1.0">
          <output id="dryOut">1.0</output>
        </label>

        <label>Lowpass (Hz)
          <input id="lp" type="range" min="200" max="6000" step="10" value="2200">
          <output id="lpOut">2200</output>
        </label>

        <label>Highpass (Hz)
          <input id="hp" type="range" min="20" max="800" step="1" value="120">
          <output id="hpOut">120</output>
        </label>

        <label>Bandpass (Hz)
          <input id="bp" type="range" min="200" max="3000" step="10" value="600">
          <output id="bpOut">600</output>
        </label>

        <label>EQ 250 Hz (dB)
          <input id="eq250" type="range" min="-12" max="12" step="0.1" value="2">
          <output id="eq250Out">2</output>
        </label>

        <label>EQ 600 Hz (dB)
          <input id="eq600" type="range" min="-12" max="12" step="0.1" value="4">
          <output id="eq600Out">4</output>
        </label>

        <label>EQ 1.2 kHz (dB)
          <input id="eq1200" type="range" min="-12" max="12" step="0.1" value="3">
          <output id="eq1200Out">3</output>
        </label>

        <label>EQ 2.5 kHz (dB)
          <input id="eq2500" type="range" min="-12" max="12" step="0.1" value="-2">
          <output id="eq2500Out">-2</output>
        </label>

        <label>Distortion
          <input id="dist" type="range" min="0" max="1000" step="1" value="180">
          <output id="distOut">180</output>
        </label>

        <label>Vibrato Depth (ms)
          <input id="vibDepth" type="range" min="0" max="15" step="0.1" value="3.5">
          <output id="vibDepthOut">3.5</output>
        </label>

        <label>Vibrato Rate (Hz)
          <input id="vibRate" type="range" min="0" max="12" step="0.1" value="5.0">
          <output id="vibRateOut">5.0</output>
        </label>

        <label>Robot Mix (AM)
          <input id="robotMix" type="range" min="0" max="1" step="0.01" value="0.25">
          <output id="robotMixOut">0.25</output>
        </label>

        <label>Robot Rate (Hz)
          <input id="robotRate" type="range" min="10" max="120" step="1" value="55">
          <output id="robotRateOut">55</output>
        </label>

        <label>Reverb (mix)
          <input id="reverb" type="range" min="0" max="1" step="0.01" value="0.25">
          <output id="reverbOut">0.25</output>
        </label>

        <label>Compressor Threshold (dB)
          <input id="comp" type="range" min="-80" max="0" step="1" value="-18">
          <output id="compOut">-18</output>
        </label>

        <label>Noise Gate Threshold
          <input id="gate" type="range" min="0.005" max="0.08" step="0.001" value="0.04">
          <output id="gateOut">0.04</output>
        </label>

        <label>Breath Volume
          <input id="breathVol" type="range" min="0" max="1" step="0.01" value="0.7">
          <output id="breathVolOut">0.7</output>
        </label>

        <label>Latency Hint
          <select id="latencyHint">
            <option value="interactive" selected>interactive (lowest)</option>
            <option value="balanced">balanced</option>
            <option value="playback">playback</option>
          </select>
        </label>
      </div>

      <div class="row">
        <button id="breathBtn">Play Breathing</button>
        <label><input type="checkbox" id="autobreath" checked> Auto between lines</label>
      </div>

      <div class="row">
        <strong>Presets:</strong>
        <button class="presetBtn" data-preset="vader">Vader Classic</button>
        <button class="presetBtn" data-preset="intercom">Imperial Intercom</button>
        <button class="presetBtn" data-preset="bounty">Bounty Hunter</button>
        <button id="savePreset">Save Current</button>
        <button id="loadPreset">Load Saved</button>
        <button id="resetPreset">Reset Defaults</button>
      </div>
    </section>


    <section class="status">
      <h2>Status</h2>
      <pre id="log"></pre>
    </section>

    <audio id="monitor" autoplay playsinline></audio>
  </main>

  <footer>
    <small>Made with the Web Audio API. Installable PWA. Use with a helmet mic + BT speaker for best effect.</small>
  </footer>

  <script src="app.js"></script>
</body>
</html>
